name: CI - PR Validation

permissions:
    contents: read

on:
    pull_request:
        branches: ["**"]

    workflow_dispatch:

jobs:
    verify_pr:
        timeout-minutes: 30

        strategy:
            fail-fast: false
            max-parallel: 20

            matrix:
                include:
                    - preset: linux-gcc
                      os: ubuntu-latest
                    - preset: linux-clang
                      os: ubuntu-latest
                    - preset: macos-clang
                      os: macos-latest
                    - preset: windows-msvc
                      os: windows-latest
                      msvc: true
                    - preset: windows-clang-cl
                      os: windows-latest
                      msvc: true
                    - preset: windows-mingw
                      os: windows-latest

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup MSVC environment
              if: matrix.msvc
              uses: ilammy/msvc-dev-cmd@v1

            - name: Run CMake workflow
              run: cmake --workflow --preset=${{ matrix.preset }}

    pr_verification_summary:
        needs: verify_pr
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: Check if all jobs succeeded
              run: |
                  if [[ "${{ needs.verify_pr.result }}" != "success" ]]; then
                      echo "One or more jobs failed"
                      exit 1
                  fi
                  echo "All jobs completed successfully"
