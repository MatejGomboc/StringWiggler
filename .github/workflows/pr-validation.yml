name: CI - PR Validation

permissions:
    contents: read

on:
    pull_request:
        branches: ["**"]
    workflow_dispatch:

env:
    VULKAN_SDK_VERSION: "1.4.335.0"

jobs:
    verify_pr:
        timeout-minutes: 30

        strategy:
            fail-fast: false
            max-parallel: 20

            matrix:
                include:
                    - preset: windows-msvc
                      os: windows-latest
                      msvc-setup-needed: true
                    - preset: linux-gcc
                      os: ubuntu-latest
                    - preset: linux-clang
                      os: ubuntu-latest
                    - preset: macos-clang
                      os: macos-latest
                    - preset: windows-clang-cl
                      os: windows-latest
                    - preset: windows-mingw
                      os: windows-latest

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout Github repository
              uses: actions/checkout@v6

            # ===== VULKAN SDK CACHING =====
            - name: Cache Vulkan SDK (Windows)
              if: runner.os == 'Windows'
              id: cache-vulkan-windows
              uses: actions/cache@v4
              with:
                  path: C:\VulkanSDK\${{ env.VULKAN_SDK_VERSION }}
                  key: vulkan-sdk-windows-${{ env.VULKAN_SDK_VERSION }}

            - name: Cache Vulkan SDK (Linux)
              if: runner.os == 'Linux'
              id: cache-vulkan-linux
              uses: actions/cache@v4
              with:
                  path: ~/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}
                  key: vulkan-sdk-linux-${{ env.VULKAN_SDK_VERSION }}

            - name: Cache Vulkan SDK (macOS)
              if: runner.os == 'macOS'
              id: cache-vulkan-macos
              uses: actions/cache@v4
              with:
                  path: ~/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}
                  key: vulkan-sdk-macos-${{ env.VULKAN_SDK_VERSION }}

            # ===== VULKAN SDK INSTALLATION =====
            - name: Install Vulkan SDK (Linux)
              if: runner.os == 'Linux' && steps.cache-vulkan-linux.outputs.cache-hit != 'true'
              run: |
                  wget -q "https://sdk.lunarg.com/sdk/download/${{ env.VULKAN_SDK_VERSION }}/linux/vulkansdk-linux-x86_64-${{ env.VULKAN_SDK_VERSION }}.tar.xz" -O vulkansdk.tar.xz
                  mkdir -p ~/VulkanSDK
                  tar -xf vulkansdk.tar.xz -C ~/VulkanSDK

            - name: Setup Vulkan SDK environment (Linux)
              if: runner.os == 'Linux'
              run: |
                  echo "VULKAN_SDK=$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/x86_64" >> $GITHUB_ENV
                  echo "$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/x86_64/bin" >> $GITHUB_PATH
                  echo "LD_LIBRARY_PATH=$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/x86_64/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

            - name: Install Vulkan SDK (macOS)
              if: runner.os == 'macOS' && steps.cache-vulkan-macos.outputs.cache-hit != 'true'
              run: |
                  wget -q "https://sdk.lunarg.com/sdk/download/${{ env.VULKAN_SDK_VERSION }}/mac/vulkansdk-macos-${{ env.VULKAN_SDK_VERSION }}.zip" -O vulkansdk.zip
                  unzip -q vulkansdk.zip
                  mkdir -p ~/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}
                  ./InstallVulkan.app/Contents/MacOS/InstallVulkan \
                      --root ~/VulkanSDK/${{ env.VULKAN_SDK_VERSION }} \
                      --accept-licenses --default-answer --confirm-command install

            - name: Setup Vulkan SDK environment (macOS)
              if: runner.os == 'macOS'
              run: |
                  echo "VULKAN_SDK=$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/macOS" >> $GITHUB_ENV
                  echo "$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/macOS/bin" >> $GITHUB_PATH
                  echo "DYLD_LIBRARY_PATH=$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/macOS/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
                  # MoltenVK ICD registration
                  echo "VK_ICD_FILENAMES=$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/macOS/share/vulkan/icd.d/MoltenVK_icd.json" >> $GITHUB_ENV
                  echo "VK_LAYER_PATH=$HOME/VulkanSDK/${{ env.VULKAN_SDK_VERSION }}/macOS/share/vulkan/explicit_layer.d" >> $GITHUB_ENV

            - name: Install Vulkan SDK (Windows)
              if: runner.os == 'Windows' && steps.cache-vulkan-windows.outputs.cache-hit != 'true'
              shell: pwsh
              run: |
                  Invoke-WebRequest -Uri "https://sdk.lunarg.com/sdk/download/${{ env.VULKAN_SDK_VERSION }}/windows/VulkanSDK-${{ env.VULKAN_SDK_VERSION }}-Installer.exe" -OutFile VulkanSDK-Installer.exe
                  Start-Process -FilePath .\VulkanSDK-Installer.exe -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait

            - name: Setup Vulkan SDK environment (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  echo "VULKAN_SDK=C:\VulkanSDK\${{ env.VULKAN_SDK_VERSION }}" >> $env:GITHUB_ENV
                  echo "C:\VulkanSDK\${{ env.VULKAN_SDK_VERSION }}\Bin" >> $env:GITHUB_PATH

            # ===== BUILD =====
            - name: Setup MSVC environment
              if: matrix.msvc-setup-needed
              uses: ilammy/msvc-dev-cmd@v1

            - name: Run CMake workflow
              run: cmake --workflow --preset=${{ matrix.preset }}

    pr_verification_summary:
        needs: verify_pr
        runs-on: ubuntu-latest
        if: always()
        steps:
            - name: Check if all jobs succeeded
              run: |
                  if [[ "${{ needs.verify_pr.result }}" != "success" ]]; then
                      echo "One or more jobs failed"
                      exit 1
                  fi
                  echo "All jobs completed successfully"
